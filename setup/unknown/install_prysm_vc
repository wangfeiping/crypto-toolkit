#/bin/bash

#
# curl https://raw.githubusercontent.com/WALL-E/static/master/setup/aws/install_prysm_vc | bash
#
# wget https://raw.githubusercontent.com/WALL-E/static/master/setup/aws/install_prysm_vc -O install_prysm_vc
#
# Prysm Validator
#
# Networkï¼šmainnet
#

set -x
set -e

role=`id -u`
if test $role -ne 0
then
    echo "You install package which requires root privileges"
    exit 1
fi


cd ~

if [ ! -f "/usr/local/bin/validator" ]
then
    echo "please install validator"
    exit
fi

# Create prysmvalidator user
egrep "^prysmvalidator" /etc/passwd >& /dev/null
if [ $? -ne 0 ]
then
  useradd --system --no-create-home --shell /sbin/nologin prysmvalidator
fi

# Create /prysm/validators directory
sudo mkdir -p /var/lib/prysm/validators

# Change ownership of /var/lib/prysm back to root
sudo chown root:root /var/lib/prysm

# Change ownership of /prysm/validators
sudo chown -R prysmvalidator:prysmvalidator /var/lib/prysm/validators

# Create prysmvalidator.service
cat > /usr/lib/systemd/system/prysmvalidator.service <<EOF
[Unit]
Description=Prysm Validator
Wants=network-online.target
After=network-online.target

[Service]
User=prysmvalidator
Group=prysmvalidator
Type=simple
Restart=always
RestartSec=5
ExecStart=/usr/local/bin/validator \
        --mainnet \
        --wallet-dir=/var/lib/prysm/.eth2validators/prysm-wallet-v2 \
        --datadir=/var/lib/prysm/validators \
        --wallet-password-file=/home/eth-user/.ssh/wp.txt \
        --monitoring-host=0.0.0.0 \
        --monitoring-port=15064 \
        --pprofport=16065

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload

# Start prysmvalidator.service
echo "sudo systemctl start prysmvalidator"

# Stop prysmvalidator.service
echo "sudo systemctl stop prysmvalidator"

# Check prysmvalidator.service output
echo "sudo journalctl -f -u prysmvalidator.service"

echo
echo "Everything is fine"
