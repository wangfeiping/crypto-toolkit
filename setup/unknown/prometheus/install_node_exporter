#/bin/bash

#
# curl https://raw.githubusercontent.com/WALL-E/static/master/setup/unknown/prometheus/install_node_exporter | bash
#
# wget https://raw.githubusercontent.com/WALL-E/static/master/setup/unknown/prometheus/install_node_exporter -O install_node_exporter
#
# node_exporter
#

set -e
set -x


# Condition check

role=`id -u`
if test $role -ne 0
then
    echo "You install package which requires root privileges"
    exit 1
fi


# Download package

VERSION=1.2.2

if [ ! -f "/usr/local/bin/node_exporter" ]
then
    cd ~
    wget https://github.com/prometheus/node_exporter/releases/download/v${VERSION}/node_exporter-${VERSION}.linux-amd64.tar.gz
      
    tar --no-same-owner -zxvf node_exporter-${VERSION}.linux-amd64.tar.gz
    mv node_exporter-${VERSION}.linux-amd64/node_exporter /usr/local/bin/
    
    rm -f node_exporter-${VERSION}.linux-amd64.tar.gz
    rm -rf node_exporter-${VERSION}.linux-amd64/
fi


# Create user

useradd --system --no-create-home --shell /sbin/nologin node-exporter


# Create systemd service

cat > /usr/lib/systemd/system/node_exporter.service <<EOF
[Unit]
Description=Prometheus node_exporter
Wants=network-online.target
After=network-online.target

[Service]
Type=simple
User=node-exporter
Group=node-exporter
Restart=always
RestartSec=5
ExecStart=/usr/local/bin/node_exporter \
  --web.listen-address=127.0.0.1:9100

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable node_exporter

echo
echo "systemctl start node_exporter"
echo "systemctl stop node_exporter"
echo "journalctl -f -u node_exporter"

echo
node_exporter --version

echo
echo "Everything is fine"
