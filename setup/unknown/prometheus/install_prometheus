#/bin/bash

#
# curl https://raw.githubusercontent.com/WALL-E/static/master/setup/unknown/prometheus/install_prometheus | bash
#
# wget https://raw.githubusercontent.com/WALL-E/static/master/setup/unknown/prometheus/install_prometheus -O install_prometheus
#
# Prometheus
#
#
# Grafana
#
# wget https://dl.grafana.com/oss/release/grafana-8.1.2-1.x86_64.rpm
# yum install grafana-8.1.2-1.x86_64.rpm
# systemctl start grafana-server
# systemctl enable grafana-server
#

set -e
set -x

# Condition check

role=`id -u`
if test $role -ne 0
then
    echo "You install package which requires root privileges"
    exit 1
fi


# Download package

VERSION=2.29.1

if [ ! -f "/apps/prometheus/prometheus" ]
then
    cd ~
    wget https://github.com/prometheus/prometheus/releases/download/v${VERSION}/prometheus-${VERSION}.linux-amd64.tar.gz
      
    tar --no-same-owner -zxvf prometheus-${VERSION}.linux-amd64.tar.gz
    mv prometheus-${VERSION}.linux-amd64/ /apps/prometheus
    
    rm -f prometheus-${VERSION}.linux-amd64.tar.gz
fi

# Create user

egrep "^prometheus" /etc/passwd >& /dev/null
if [ $? -ne 0 ]
then
  useradd --system --no-create-home --shell /sbin/nologin prometheus
fi

mkdir -p /apps/prometheus/data
chown prometheus:prometheus /apps/prometheus -R
chmod 700 /apps/prometheus -R


# Create systemd service

cat > /usr/lib/systemd/system/prometheus.service <<EOF
[Unit]
Description=Prometheus
Wants=network-online.target
After=network-online.target

[Service]
Type=simple
User=prometheus
Group=prometheus
Restart=always
RestartSec=5
ExecStart=/apps/prometheus/prometheus \
  --config.file="/apps/prometheus/prometheus.yml" \
  --storage.tsdb.retention.time=39d \
  --storage.tsdb.path=/apps/prometheus/data/

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable node_exporter

echo
echo "systemctl start node_exporter"
echo "systemctl stop node_exporter"
echo "journalctl -f -u node_exporter.service"

echo
prometheus --version

echo
echo "Everything is fine"
